<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mosaic Gallery — Infinite, Color-Sorted, Lightbox</title>

<style>
  :root{
    --bg: #ffffff;
    --gap: 8px;
    --col-min: 220px;
    --overlay-bg: rgba(0,0,0,.72);
    --back-size: 36px;
    --fade-cell: 60px;
  }

  html,body{
    height:100%;
    background:var(--bg);
    margin:0;
    padding:0;
    overflow-x:hidden;
    color:#111;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  }

  /* Back arrow */
  .back-btn{
    position:fixed; top:16px; left:16px;
    width:var(--back-size); height:var(--back-size);
    display:grid; place-items:center;
    text-decoration:none;
    background:#000;
    color:#fff;
    border-radius:8px;
    z-index:10001;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
    transition:transform .12s ease, opacity .18s ease;
  }
  .back-btn:hover{ transform:translateX(-2px); opacity:.9; }
  .back-btn svg{ width:22px; height:22px; }

  /* Masonry grid */
  .gallery{
    column-width: var(--col-min);
    column-gap: var(--gap);
    padding: calc(var(--gap) + 16px);
    max-width: 1400px;
    margin: 0 auto;
  }
  .tile{
    display:block;
    break-inside: avoid;
    margin: 0 0 var(--gap) 0;
    border-radius: 10px;
    overflow:hidden;
    background:#f6f6f6;
    box-shadow: 0 1px 2px rgba(0,0,0,.06);
    position:relative;
  }
  .tile img{
    width:100%;
    height:auto;
    display:block;
    vertical-align:bottom;
    object-fit:cover;
  }

  /* Lightbox */
  .lightbox{
    position:fixed; inset:0;
    background:var(--overlay-bg);
    display:none;
    align-items:center; justify-content:center;
    z-index:10000;
    padding:24px;
  }
  .lightbox.open{ display:flex; }
  .lightbox__inner{
    position:relative; max-width: min(1400px, 96vw); max-height: 90vh;
  }
  .lightbox__img{
    max-width:100%; max-height:90vh;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.4);
  }
  .lightbox__close{
    position:absolute; top:8px; left:8px;
    width:36px; height:36px; border-radius:8px; border:0;
    display:grid; place-items:center;
    background:#000; color:#fff; cursor:pointer;
  }

  /* Startup fade */
  #white-transition{
    position:fixed; inset:0;
    background:#000;
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(var(--fade-cell), 1fr));
    grid-auto-rows: var(--fade-cell);
    z-index: 10002;
    pointer-events:none;
  }
  .white-block{ background:#fff; opacity:0; transition:none; }

  @media (max-width: 720px){
    :root{ --gap: 6px; --col-min: 170px; }
  }
  @media (max-width: 420px){
    :root{ --col-min: 150px; }
  }
</style>
</head>

<body>
<!-- Back button -->
<a class="back-btn" href="work.html" aria-label="Back to Work">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
       stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <path d="M15 18l-6-6 6-6"/>
  </svg>
</a>

<!-- Gallery -->
<main id="gallery" class="gallery" aria-live="polite"></main>

<!-- Lightbox -->
<div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Image preview">
  <div class="lightbox__inner">
    <button class="lightbox__close" aria-label="Close (Esc)">&times;</button>
    <img id="lightbox-img" class="lightbox__img" alt="" />
  </div>
</div>

<!-- Fade transition -->
<div id="white-transition" aria-hidden="true"></div>

<script>
// ===== CONFIG =====
// Corrected for GitHub Pages under /owendenveremerson/
const REPO_BASE = "/owendenveremerson/";
const IMAGE_BASE_PATH = REPO_BASE + "websitephotos/";
const MANIFEST_URL = REPO_BASE + "photolist.json";

const BATCH_SIZE = 60;

// ===== Lightbox logic =====
const lightbox = document.getElementById("lightbox");
const lightboxImg = document.getElementById("lightbox-img");
function openLightbox(src){ lightboxImg.src = src; lightbox.classList.add("open"); }
function closeLightbox(){ lightbox.classList.remove("open"); lightboxImg.src=""; }
lightbox.addEventListener("click", e => { if(e.target===lightbox) closeLightbox(); });
lightbox.querySelector(".lightbox__close").addEventListener("click", closeLightbox);
document.addEventListener("keydown", e => { if(e.key==="Escape") closeLightbox(); });

// ===== Average color helper =====
function averageHSL(img){
  try{
    const w = 32, h = Math.max(8, Math.round(32 * (img.naturalHeight / img.naturalWidth || 1)));
    const c = document.createElement("canvas");
    c.width=w; c.height=h;
    const ctx=c.getContext("2d");
    ctx.drawImage(img,0,0,w,h);
    const data=ctx.getImageData(0,0,w,h).data;
    let r=0,g=0,b=0,count=w*h;
    for(let i=0;i<data.length;i+=4){r+=data[i];g+=data[i+1];b+=data[i+2];}
    r/=count; g/=count; b/=count;
    r/=255; g/=255; b/=255;
    const max=Math.max(r,g,b), min=Math.min(r,g,b);
    let hsl_h, hsl_s, l=(max+min)/2;
    if(max===min){hsl_h=0; hsl_s=0;}
    else{
      const d=max-min;
      hsl_s=l>0.5?d/(2-max-min):d/(max+min);
      switch(max){
        case r: hsl_h=(g-b)/d+(g<b?6:0); break;
        case g: hsl_h=(b-r)/d+2; break;
        default: hsl_h=(r-g)/d+4; break;
      }
      hsl_h/=6;
    }
    return {h:hsl_h,s:hsl_s,l:l};
  }catch{return {h:0,s:0,l:0};}
}

// ===== Gallery logic =====
const gallery=document.getElementById("gallery");
let canonical=[], appendedWraps=0;

function makeTile(src){
  const a=document.createElement("a");
  a.className="tile";
  a.href=src;
  a.addEventListener("click",e=>{e.preventDefault();openLightbox(src);});
  const img=document.createElement("img");
  img.loading="lazy"; img.decoding="async"; img.src=src;
  img.alt="";
  a.appendChild(img);
  return {el:a,img};
}

async function buildColorSortedGallery(srcList){
  if(!srcList.length)return;
const items = await Promise.all(srcList.map(src => new Promise(resolve => {
  const { el, img } = makeTile(src);
  let settled = false;

  const finalize = (h,s,l) => {
    if (settled) return;
    settled = true;
    resolve({ el, img, src, h, s, l });
  };

  img.addEventListener("load", () => {
    const { h, s, l } = averageHSL(img);
    finalize(h, s, l);
  }, { once: true });

  img.addEventListener("error", () => finalize(0, 0, 0.5), { once: true });

  // fallback: resolve anyway after 3s
  setTimeout(() => finalize(0, 0, 0.5), 3000);
})));

  items.sort((a,b)=>a.h===b.h ? a.l-b.l : a.h-b.h);
  canonical=items.map(x=>x.el);
  renderInitial(canonical);
  window.addEventListener("scroll",maybeAppendWrap);
}

function renderInitial(list){
  gallery.innerHTML="";
  const frag=document.createDocumentFragment();
  list.forEach(el=>frag.appendChild(el.cloneNode(true)));
  gallery.appendChild(frag);
  appendedWraps=1;
}

function maybeAppendWrap(){
  const {scrollTop,clientHeight,scrollHeight}=document.documentElement;
  if(scrollTop+clientHeight>scrollHeight-600){ appendNextWrap(); }
}
function appendNextWrap(){
  const startIndex=(appendedWraps*BATCH_SIZE)%canonical.length;
  const frag=document.createDocumentFragment();
  for(let i=0;i<BATCH_SIZE;i++){
    const idx=(startIndex+i)%canonical.length;
    frag.appendChild(canonical[idx].cloneNode(true));
  }
  gallery.appendChild(frag);
  appendedWraps++;
}

// ===== Load from photolist.json =====
async function loadImages(){
  try{
    const res=await fetch(MANIFEST_URL);
    const list=await res.json();
    const full=list.map(name=>IMAGE_BASE_PATH+name);
    console.log("Photo list loaded:", full);
    await buildColorSortedGallery(full);
  }catch(err){
    console.error("Failed to load photolist.json:",err);
    gallery.textContent="⚠️ Could not load photo list.";
  }
}
document.addEventListener("DOMContentLoaded",loadImages);

// ===== Fade-in transition =====
document.addEventListener("DOMContentLoaded",()=>{
  const container=document.getElementById("white-transition");
  const cols=Math.ceil(window.innerWidth/parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fade-cell')));
  const rows=Math.ceil(window.innerHeight/parseInt(getComputedStyle(document.documentElement).getPropertyValue('--fade-cell')));
  const total=cols*rows;
  for(let i=0;i<total;i++){const b=document.createElement("div");b.className="white-block";container.appendChild(b);}
  const blocks=Array.from(container.children); blocks.sort(()=>Math.random()-0.5);
  let index=0; const step=25;
  const interval=setInterval(()=>{
    for(let i=0;i<step&&index<blocks.length;i++,index++){blocks[index].style.opacity=1;}
    if(index>=blocks.length){
      clearInterval(interval);
      setTimeout(()=>{
        container.style.transition="opacity 0.3s ease-out";
        container.style.opacity=0;
        setTimeout(()=>container.remove(),400);
      },150);
    }
  },25);
});
</script>
</body>
</html>
